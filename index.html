<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contact Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and Babel -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <!-- Inter Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
  </head>
  <body
    class="bg-gradient-to-br from-gray-900 to-gray-800 min-h-screen text-white font-sans"
  >
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useCallback } = React;
      const { motion, AnimatePresence } = window.framerMotion;

      // API Configuration
      const API_BASE_URL = (() => {
        // Try to connect to different ports if the default one is not available
        const ports = [3000, 3001, 3002, 3003, 3004];
        return async () => {
          for (const port of ports) {
            try {
              const response = await fetch(
                `http://localhost:${port}/api/contacts`
              );
              if (response.ok) {
                return `http://localhost:${port}`;
              }
            } catch (error) {
              continue;
            }
          }
          throw new Error("Could not connect to the server");
        };
      })();

      // Toast Component
      const Toast = ({ message, type, onClose }) => (
        <motion.div
          initial={{ opacity: 0, y: 50 }}
          animate={{ opacity: 1, y: 0 }}
          exit={{ opacity: 0, y: 50 }}
          className={`fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg ${
            type === "error" ? "bg-red-500" : "bg-green-500"
          }`}
        >
          {message}
        </motion.div>
      );

      // Contact Form Component
      const ContactForm = ({ contact, onSubmit, onClose }) => {
        const [formData, setFormData] = useState(
          contact || { name: "", phone: "", email: "" }
        );
        const [errors, setErrors] = useState({});

        const validateForm = () => {
          const newErrors = {};
          if (!formData.name.trim()) newErrors.name = "Name is required";
          if (!formData.phone.trim()) newErrors.phone = "Phone is required";
          if (!formData.email.trim()) newErrors.email = "Email is required";
          else if (!/\S+@\S+\.\S+/.test(formData.email))
            newErrors.email = "Invalid email format";
          setErrors(newErrors);
          return Object.keys(newErrors).length === 0;
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          if (validateForm()) {
            onSubmit(formData);
          }
        };

        return (
          <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.9 }}
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"
          >
            <div className="bg-gray-800 rounded-xl p-6 w-full max-w-md">
              <h2 className="text-2xl font-bold mb-4">
                {contact ? "Edit Contact" : "Add Contact"}
              </h2>
              <form onSubmit={handleSubmit}>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">
                      Name
                    </label>
                    <input
                      type="text"
                      value={formData.name}
                      onChange={(e) =>
                        setFormData({ ...formData, name: e.target.value })
                      }
                      className="w-full px-4 py-2 rounded-lg bg-gray-700 focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                    {errors.name && (
                      <p className="text-red-500 text-sm mt-1">{errors.name}</p>
                    )}
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">
                      Phone
                    </label>
                    <input
                      type="tel"
                      value={formData.phone}
                      onChange={(e) =>
                        setFormData({ ...formData, phone: e.target.value })
                      }
                      className="w-full px-4 py-2 rounded-lg bg-gray-700 focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                    {errors.phone && (
                      <p className="text-red-500 text-sm mt-1">
                        {errors.phone}
                      </p>
                    )}
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">
                      Email
                    </label>
                    <input
                      type="email"
                      value={formData.email}
                      onChange={(e) =>
                        setFormData({ ...formData, email: e.target.value })
                      }
                      className="w-full px-4 py-2 rounded-lg bg-gray-700 focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                    {errors.email && (
                      <p className="text-red-500 text-sm mt-1">
                        {errors.email}
                      </p>
                    )}
                  </div>
                </div>
                <div className="flex justify-end space-x-3 mt-6">
                  <button
                    type="button"
                    onClick={onClose}
                    className="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors"
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    className="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 transition-colors"
                  >
                    {contact ? "Update" : "Add"}
                  </button>
                </div>
              </form>
            </div>
          </motion.div>
        );
      };

      // Contact Card Component
      const ContactCard = ({ contact, onEdit, onDelete }) => (
        <motion.div
          layout
          initial={{ opacity: 0, scale: 0.9 }}
          animate={{ opacity: 1, scale: 1 }}
          exit={{ opacity: 0, scale: 0.9 }}
          whileHover={{ scale: 1.02 }}
          className="bg-gray-800 rounded-xl p-6 backdrop-blur-lg bg-opacity-50 shadow-xl"
        >
          <h3 className="text-xl font-semibold mb-2">{contact.name}</h3>
          <p className="text-gray-300 mb-1">{contact.phone}</p>
          <p className="text-gray-300 mb-4">{contact.email}</p>
          <div className="flex justify-end space-x-2">
            <button
              onClick={() => onEdit(contact)}
              className="px-3 py-1 rounded-lg bg-blue-500 hover:bg-blue-600 transition-colors text-sm"
            >
              Edit
            </button>
            <button
              onClick={() => onDelete(contact.id)}
              className="px-3 py-1 rounded-lg bg-red-500 hover:bg-red-600 transition-colors text-sm"
            >
              Delete
            </button>
          </div>
        </motion.div>
      );

      // Search Bar Component
      const SearchBar = ({ onSearch }) => {
        const [query, setQuery] = useState("");

        const handleChange = (e) => {
          const value = e.target.value;
          setQuery(value);
          onSearch(value);
        };

        return (
          <div className="relative mb-6">
            <input
              type="text"
              value={query}
              onChange={handleChange}
              placeholder="Search contacts..."
              className="w-full px-4 py-2 rounded-lg bg-gray-700 focus:ring-2 focus:ring-blue-500 outline-none"
            />
            {query && (
              <button
                onClick={() => {
                  setQuery("");
                  onSearch("");
                }}
                className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white"
              >
                Ã—
              </button>
            )}
          </div>
        );
      };

      // Main App Component
      const App = () => {
        const [contacts, setContacts] = useState([]);
        const [filteredContacts, setFilteredContacts] = useState([]);
        const [selectedContact, setSelectedContact] = useState(null);
        const [showForm, setShowForm] = useState(false);
        const [toast, setToast] = useState(null);
        const [baseUrl, setBaseUrl] = useState(null);
        const [isLoading, setIsLoading] = useState(true);

        const showToast = (message, type = "success") => {
          setToast({ message, type });
          setTimeout(() => setToast(null), 3000);
        };

        // Initialize API connection
        useEffect(() => {
          const initializeApi = async () => {
            try {
              const url = await API_BASE_URL();
              setBaseUrl(url);
              setIsLoading(false);
            } catch (error) {
              showToast(
                "Failed to connect to server. Please ensure the server is running.",
                "error"
              );
              setIsLoading(false);
            }
          };
          initializeApi();
        }, []);

        const fetchContacts = async () => {
          if (!baseUrl) return;
          try {
            const response = await fetch(`${baseUrl}/api/contacts`);
            if (!response.ok) throw new Error("Failed to fetch contacts");
            const data = await response.json();
            setContacts(data);
            setFilteredContacts(data);
          } catch (error) {
            showToast("Failed to fetch contacts", "error");
          }
        };

        useEffect(() => {
          if (baseUrl) {
            fetchContacts();
          }
        }, [baseUrl]);

        const handleSearch = async (query) => {
          if (!baseUrl) return;
          try {
            const response = await fetch(
              `${baseUrl}/api/contacts/search?q=${query}`
            );
            if (!response.ok) throw new Error("Search failed");
            const data = await response.json();
            setFilteredContacts(data);
          } catch (error) {
            showToast("Search failed", "error");
          }
        };

        const handleSubmit = async (formData) => {
          if (!baseUrl) return;
          try {
            const url = selectedContact
              ? `${baseUrl}/api/contacts/${selectedContact.id}`
              : `${baseUrl}/api/contacts`;
            const method = selectedContact ? "PUT" : "POST";

            const response = await fetch(url, {
              method,
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(formData),
            });

            if (!response.ok) throw new Error("Failed to save contact");

            showToast(
              selectedContact
                ? "Contact updated successfully"
                : "Contact added successfully"
            );
            setShowForm(false);
            setSelectedContact(null);
            fetchContacts();
          } catch (error) {
            showToast("Failed to save contact", "error");
          }
        };

        const handleDelete = async (id) => {
          if (!baseUrl) return;
          if (!confirm("Are you sure you want to delete this contact?")) return;

          try {
            const response = await fetch(`${baseUrl}/api/contacts/${id}`, {
              method: "DELETE",
            });

            if (!response.ok) throw new Error("Failed to delete contact");

            showToast("Contact deleted successfully");
            fetchContacts();
          } catch (error) {
            showToast("Failed to delete contact", "error");
          }
        };

        if (isLoading) {
          return (
            <div className="container mx-auto px-4 py-8 flex items-center justify-center min-h-screen">
              <div className="text-xl">Loading...</div>
            </div>
          );
        }

        if (!baseUrl) {
          return (
            <div className="container mx-auto px-4 py-8 flex items-center justify-center min-h-screen">
              <div className="text-xl text-red-500">
                Could not connect to server. Please ensure the server is
                running.
              </div>
            </div>
          );
        }

        return (
          <div className="container mx-auto px-4 py-8 max-w-6xl">
            <div className="flex justify-between items-center mb-8">
              <h1 className="text-4xl font-bold">Contact Manager</h1>
              <motion.button
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                onClick={() => {
                  setSelectedContact(null);
                  setShowForm(true);
                }}
                className="px-6 py-3 rounded-lg bg-blue-500 hover:bg-blue-600 transition-colors font-semibold"
              >
                Add Contact
              </motion.button>
            </div>

            <SearchBar onSearch={handleSearch} />

            <motion.div
              layout
              className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
            >
              <AnimatePresence>
                {filteredContacts.map((contact) => (
                  <ContactCard
                    key={contact.id}
                    contact={contact}
                    onEdit={(contact) => {
                      setSelectedContact(contact);
                      setShowForm(true);
                    }}
                    onDelete={handleDelete}
                  />
                ))}
              </AnimatePresence>
            </motion.div>

            <AnimatePresence>
              {showForm && (
                <ContactForm
                  contact={selectedContact}
                  onSubmit={handleSubmit}
                  onClose={() => {
                    setShowForm(false);
                    setSelectedContact(null);
                  }}
                />
              )}
              {toast && <Toast {...toast} />}
            </AnimatePresence>
          </div>
        );
      };

      // Render the app
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
